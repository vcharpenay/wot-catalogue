<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>WoT Catalogue - Collection of formal concepts from the Web of Things</title>
        
        <script src="js/lunr.js"></script>
        <script src="js/urdf-browser.js"></script>

        <style>
            body {
                margin: 0;
                font-family: 'Courier New', Courier, monospace;
            }

            #title {
                font-weight: bold;
                font-size: 20px;
                margin-right: 20px;
            }

            #search-bar {
                padding: 10px;
                border-bottom: 1px solid grey;
            }

            #search-results {
                padding: 10px;
            }

            #search-results-count {
                margin: 0;
                margin-bottom: 10px;
                font-style: italic;
            }
        </style>
    </head>

    <body>
        <div id="search-bar">
            <span id="title">WoT Catalogue</span>
            <input id="search-field" type="text" placeholder="Enter a concept name...">
            <input id="search-button" type="button" value="Search">
        </div>

        <div id="search-results">
            <p id="search-results-count">
                Downloading knowledge base...
            </p>
            <table>
                <tbody id="search-results-list">

                </tbody>                
            </table>
        </div>

        <script id="catalogue-query" type="application/sparql-query">
            prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>
            prefix skos: <http://www.w3.org/2004/02/skos/core#>
            select ?concept ?scheme ?raw ?label ?definition where {
                graph ?raw {
                    ?concept a skos:Concept ;
                             rdfs:label ?label ;
                             skos:definition ?definition .
                }
                # scheme name as folder name
                bind (replace(str(?raw), "https://raw.githubusercontent.com/vcharpenay/wot-catalogue/master/", "") as ?local)
                bind (strbefore(?local, "/") as ?scheme)
            }
        </script>
        
        <script>
            const catalogue = document.getElementById('catalogue-query');
            const btn = document.getElementById('search-button');
            const field = document.getElementById('search-field');
            const meta = document.getElementById('search-results-count');
            const list = document.getElementById('search-results-list');

            const base = 'https://raw.githubusercontent.com/vcharpenay/wot-catalogue/master';
            const files = [
                '/BACnet/bacnet.ttl',
                '/LWM2M/ipso.ttl',
                '/OCF/oneiota.ttl',
                '/oneM2M/haim.ttl',
                '/BACnet/bacnet.ttl',
                '/Project Haystack/haystack.ttl',
                '/BLE GATT/gatt.ttl'
            ];

            let race = files.map(f => urdf.loadFrom(base + f, { format: 'text/turtle' }));
            Promise.all(race)
            
            .then(() => urdf.query(catalogue.innerText))

            .then(res => {
                let docs = res.map(b => {
                    let doc = {};
                    for (k in b) doc[k] = b[k].value;
                    return doc;
                });

                const idx = lunr(function() {
                    this.ref('concept');
                    this.field('label');
                    this.field('definition');

                    docs.forEach(doc => this.add(doc), this);
                });

                btn.onclick = () => {
                    let res = idx.search(field.value);
                    console.log(res)

                    meta.innerText = `${res.length} result(s) found.`;
                    
                    list.innerHTML = res.reduce((arr, m) => {
                        let doc = docs.find(doc => doc.concept == m.ref);
                        let row = `<tr title="${doc.concept}">\
                            <td><a href="${doc.raw}">${doc.scheme}</a></td>\
                            <td><b>${doc.label}<b></td>\
                            <td>${doc.definition}</td>\
                        </tr>`;
                        return arr + row;
                    }, '');
                };

                field.onkeyup = e => { if (e.key == 'Enter') btn.onclick(); }

                meta.innerText = '';
            })

            .catch(e => {
                // TODO
                console.error(e);
            });
        </script>
    </body>
</html>