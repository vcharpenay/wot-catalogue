@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix log: <http://www.w3.org/2000/10/swap/log#> .
@prefix string: <http://www.w3.org/2000/10/swap/string#> .
@prefix wd: <http://www.wikidata.org/entity/> .
@prefix wdt: <http://www.wikidata.org/prop/direct/> .
@prefix : <http://ti.rw.fau.de/vocab#> .

# ldfu -i wikidata-entities.nt wikidata-hierarchy.nt wikidata-unique-matches.nt -p _script/filter-closure.n3 -q _script/filter-closure.rq wikidata-closure.nt

# initial selection of closure nodes

{ ?tag skos:closeMatch ?e . } => { ?e a :ClosureNode . } .

# selection of closure nodes based on neighborhood
# if crawling depth equals 2, the furthest neigbor is max. 4 hops away

{
    ?e1 ?p ?e2 .
    ?p log:notEqualTo wdt:P31 .
    ?p log:notEqualTo wdt:P279 .
    ?p log:uriToString ?str .
    ?str string:startsWith "http://www.wikidata.org/prop/direct/" .
}
=>
{
    ?p a :Edge .
} .

{ ?p a :Edge . } => { ?p a :ClosureEdge . } .

{
   ?e1 ?p1 ?e2 . ?e2 ?p2 ?e3 .
   ?e1 a :ClosureNode . ?e3 a :ClosureNode .
   ?p1 a :Edge . ?p2 a :Edge .
}
=>
{
   ?e2 a :ClosureNode .
} .

{
   ?e1 ?p1 ?e2 . ?e2 ?p2 ?e3 . ?e3 ?p3 ?e4 .
   ?e1 a :ClosureNode . ?e4 a :ClosureNode .
   ?p1 a :Edge . ?p2 a :Edge . ?p3 a :Edge .
}
=>
{
   ?e3 a :ClosureNode .
} .

{
   ?e1 ?p1 ?e2 . ?e2 ?p2 ?e3 . ?e3 ?p3 ?e4 . ?e4 ?p4 ?e5 .
   ?e1 a :ClosureNode . ?e5 a :ClosureNode .
   ?p1 a :Edge . ?p2 a :Edge . ?p3 a :Edge . ?p4 a :Edge .
}
=>
{
   ?e4 a :ClosureNode .
} .

# selection of closure nodes based on hierarchy
# if crawling depth is 6, the highest parent is also 6 hops away

wd:Q937228 a :HierarchyNode .
wd:Q1183543 a :HierarchyNode .

{ ?e1 wdt:P31 ?e2 . ?e2 a :HierarchyNode . } => { ?e1 a :HierarchyNode . } .
{ ?e1 wdt:P279 ?e2 . ?e2 a :HierarchyNode . } => { ?e1 a :HierarchyNode . } .

{ ?e1 wdt:P31 ?e2 ; a :ClosureNode . ?e2 a :HierarchyNode . } => { ?e2 a :ClosureNode . } .
{ ?e1 wdt:P279 ?e2 ; a :ClosureNode . ?e2 a :HierarchyNode . } => { ?e2 a :ClosureNode . } .

wdt:P31 a :ClosureEdge .
wdt:P279 a :ClosureEdge .